#!/usr/bin/env bash

set -euo pipefail

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(dirname "$DIR")"

source "$REPO_DIR/lib/profile.sh"
select_profile "$REPO_DIR" "${1:-}"

install_packages() {
  local file="$1"
  local layer="$2"
  local packages
  packages="$(cat "$file")"

  if [[ -z "$packages" ]]; then
    return
  fi

  echo "Installing packages from layer '$layer'..."

  if command -v brew &>/dev/null; then
    brew install $packages
  elif command -v apt-get &>/dev/null; then
    sudo apt-get install -y $packages
  else
    echo "No supported package manager found (brew or apt)." >&2
    echo "Packages to install manually: $packages" >&2
  fi
}

for layer in "${PROFILE_LAYERS[@]}"; do
  LAYER_PACKAGES="$DIR/layers/$layer"
  if [[ -f "$LAYER_PACKAGES" ]]; then
    install_packages "$LAYER_PACKAGES" "$layer"
  fi
done

echo ""
echo "Done! Packages for profile '$PROFILE' installed (layers: ${PROFILE_LAYERS[*]})."
